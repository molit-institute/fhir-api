<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import axios from "axios";
import qs from "qs";
import { get } from "lodash";

/**
 * Fetches resource(s) by the given &lt;code>url&lt;/code>.
 *
 * @param {String} url - the url
 * @param {Object} [params = {}] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchByUrl(url, params = {}, token) {
  if (!url) {
    throw new Error("Fetching the resource(s) failed because the given url was null or undefined");
  }

  const headers = {
    "Cache-Control": "no-cache"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    params,
    headers
  };
  return axios.get(url, options);
}

/**
 * Fetches the resource from the FHIR server with the given &lt;code>id&lt;/code>.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {String} resourceType - the type of the FHIR resource
 * @param {String} id - id of the resource to be fetched
 * @param {Object} [params = {}] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchResource(fhirBaseUrl, resourceType, id, params = {}, token) {
  if (!fhirBaseUrl) {
    throw new Error("Fetching the resources failed because the given fhirBaseUrl was null or undefined");
  }

  if (!resourceType) {
    throw new Error("Fetching the resources failed because the given resourceType was null or undefined");
  }

  if (id === null || id === undefined) {
    throw new Error("Fetching the resource failed because the given id was null or undefined");
  }

  const url = `${fhirBaseUrl}/${resourceType}/${id}`;
  const headers = {
    "Cache-Control": "no-cache"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    params,
    headers
  };

  return axios.get(url, options);
}

/**
 * Fetches resources from a FHIR server using a GET request.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {String} resourceType - the type of the FHIR resource
 * @param {Object} [params = {}] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchResources(fhirBaseUrl, resourceType, params = {}, token) {
  if (!fhirBaseUrl) {
    throw new Error("Fetching the resources failed because the given fhirBaseUrl was null or undefined");
  }

  if (!resourceType) {
    throw new Error("Fetching the resources failed because the given resourceType was null or undefined");
  }

  const url = `${fhirBaseUrl}/${resourceType}`;
  const headers = {
    "Cache-Control": "no-cache"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    headers,
    params
  };

  if (!(params instanceof URLSearchParams)) {
    options.paramsSerializer = params => qs.stringify(params, { arrayFormat: "repeat" });
  }

  return axios.get(url, options);
}

/**
 * Fetches a ValueSet by the given url and returns the concept.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {String} [token] - the authentication token
 * @param {String} url - the url of the resource
 * @returns {Array} - the cpncept
 */
export async function fetchValueSetConceptByUrl(fhirBaseUrl, token, url) {
  const response = await fetchResources(fhirBaseUrl, "ValueSet", { url }, token);
  const valueSet = mapFhirResponse(response)[0];

  if (!valueSet) {
    throw new Error("ValueSet '" + url + "' not found on server.");
  }

  return get(valueSet, "compose.include[0].concept", []);
}

/**
 * Fetches resources from a FHIR server using a POST request.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {String} resourceType - the type of the FHIR resource
 * @param {Object} [params = {}] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchResourcesPost(fhirBaseUrl, resourceType, params = {}, token) {
  if (!fhirBaseUrl) {
    throw new Error("Fetching the resources failed because the given fhirBaseUrl was null or undefined");
  }

  if (!resourceType) {
    throw new Error("Fetching the resources failed because the given resourceType was null or undefined");
  }

  const url = `${fhirBaseUrl}/${resourceType}/_search`;
  const headers = {
    "Cache-Control": "no-cache"
  };

  let urlSearchParams = new URLSearchParams();

  for (let p in params) {
    urlSearchParams.append(p, params[p]);
  }

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    headers
  };

  return axios.post(url, urlSearchParams, options);
}

/**
 * Submits a given resource to the server
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} resource - resource that is supposed to be submitted
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function submitResource(fhirBaseUrl, resource, token) {
  if (!fhirBaseUrl) {
    throw new Error("Resource was not submitted because the given fhirBaseUrl was null or undefined");
  }

  if (!resource) {
    throw new Error("Resource was not submitted because the given resource was null or undefined");
  }

  if (!resource.resourceType) {
    throw new Error("Invalid JSON content detected, missing required element: 'resourceType'");
  }

  let url;

  if (resource.resourceType === "Bundle" &amp;&amp; resource.type === "transaction") {
    url = `${fhirBaseUrl}/`;
  } else {
    url = `${fhirBaseUrl}/${resource.resourceType}`;
  }

  const headers = {
    "Cache-Control": "no-cache",
    "Content-Type": "application/json"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    headers
  };

  return axios.post(url, resource, options);
}

/**
 * Submits a given Resource to a Url
 * @param {*} baseUrl
 * @param {*} resource
 * @param {*} token
 */
export function submitResourceToUrl(baseUrl, resource, token) {
  if (!baseUrl) {
    throw new Error("Resource was not submitted because the given fhirBaseUrl was null or undefined");
  }

  if (!resource) {
    throw new Error("Resource was not submitted because the given resource was null or undefined");
  }
  const headers = {
    "Cache-Control": "no-cache",
    "Content-Type": "application/json"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    headers
  };
  return axios.post(baseUrl, resource, options);
}

/**
 * Updates an existing FHIR resource on the FHIR server.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} resource - resource that is supposed to be submitted
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function updateResource(fhirBaseUrl, resource, token) {
  if (!fhirBaseUrl) {
    throw new Error("Resource was not submitted because the given fhirBaseUrl was null or undefined");
  }

  if (!resource) {
    throw new Error("Resource was not submitted because the given resource was null or undefined");
  }

  if (!resource.resourceType) {
    throw new Error("Invalid JSON content detected, missing required element: 'resourceType'");
  }

  if (resource.id === null || resource.id === undefined) {
    throw new Error("Can not update resource, resource body must contain an ID element for update (PUT) operation");
  }

  const url = `${fhirBaseUrl}/${resource.resourceType}/${resource.id}`;
  const headers = {
    "Cache-Control": "no-cache",
    "Content-Type": "application/json"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    headers
  };

  return axios.put(url, resource, options);
}

/**
 * Updates an existing FHIR resource on the FHIR server or creates a new resource if no id is in the given FHIR resource.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} resource - resource that is supposed to be submitted
 * @param {Object} [params = {}] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function updateResourceByUrl(fhirBaseUrl, resource, params = {}, token) {
  if (!fhirBaseUrl) {
    throw new Error("Resource was not submitted because the given fhirBaseUrl was null or undefined");
  }

  if (!resource) {
    throw new Error("Resource was not submitted because the given resource was null or undefined");
  }

  if (!resource.resourceType) {
    throw new Error("Invalid JSON content detected, missing required element: 'resourceType'");
  }

  const url = `${fhirBaseUrl}/${resource.resourceType}`;
  const headers = {
    "Cache-Control": "no-cache",
    "Content-Type": "application/json"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    params,
    headers
  };

  return axios.put(url, resource, options);
}

/**
 * Deletes a FHIR resource from the FHIR server.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} resource - resource that is supposed to be deleted
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function deleteResource(fhirBaseUrl, resource, token) {
  if (!fhirBaseUrl) {
    throw new Error("Resource was not deleted because the given fhirBaseUrl was null or undefined");
  }

  if (!resource) {
    throw new Error("Resource was not deleted because the given resource was null or undefined");
  }

  if (!resource.resourceType) {
    throw new Error("Invalid JSON content detected, missing required element: 'resourceType'");
  }

  if (resource.id === null || resource.id === undefined) {
    throw new Error("Can not delete resource, resource body must contain an ID element for delete (DELETE) operation");
  }

  const url = `${fhirBaseUrl}/${resource.resourceType}/${resource.id}`;
  const headers = {
    "Cache-Control": "no-cache",
    "Content-Type": "application/json"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    headers
  };

  return axios.delete(url, options);
}

/**
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} resourceType - the type of the FHIR resource
 * @param {String} id - id of the resource to be deleted
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function deleteResourceById(fhirBaseUrl, resourceType, id, token) {
  if (!fhirBaseUrl) {
    throw new Error("Resource was not deleted because the given fhirBaseUrl was null or undefined");
  }

  if (!resourceType) {
    throw new Error("Resource was not deleted because the given resourceType was null or undefined");
  }

  if (id === null || id === undefined) {
    throw new Error("Can not delete resource, resource body must contain an ID element for delete (DELETE) operation");
  }

  const url = `${fhirBaseUrl}/${resourceType}/${id}`;
  const headers = {
    "Cache-Control": "no-cache",
    "Content-Type": "application/json"
  };

  if (token) {
    headers.Authorization = "Bearer " + token;
  }

  const options = {
    headers
  };

  return axios.delete(url, options);
}

/**
 * Maps the response of a FHIR search query bundle to the actual FHIR resources.
 *
 * @example
 * &lt;caption>Basic usage&lt;/caption>
 * import fhirApi from "@molit/fhir-api";
 *
 * console.log(bundle);
 * // ->
 * // {
 * //   "resourceType": "Bundle",
 * //   "type": "searchset",
 * //   "total": 2,
 * //   "entry": [
 * //     {
 * //       "fullUrl": "\thttps://fhir.molit.eu/baseDstu3/Patient/6",
 * //       "resource": {
 * //         "resourceType": "Patient",
 * //         "id": "6"
 * //       }
 * //     },
 * //     {
 * //       "fullUrl": "\thttps://fhir.molit.eu/baseDstu3/Patient/8",
 * //       "resource": {
 * //         "resourceType": "Patient",
 * //         "id": "8"
 * //       }
 * //     }
 * //   ]
 * // }
 *
 * let patients = fhirApi.mapFhirData(bundle);
 * console.log(patients)
 * // ->
 * // [
 * //   {
 * //     "resourceType": "Patient",
 * //     "id": "6"
 * //   },
 * //   {
 * //     "resourceType": "Patient",
 * //     "id": "8"
 * //   }
 * // ]
 *
 * @param {Object} data - a FHIR search bundle.
 * @returns {Array} the resources in an array
 */
export function mapFhirData(data) {
  if (!data || !data.entry || !Array.isArray(data.entry)) {
    return [];
  }
  return data.entry.map(element => element.resource);
}

/**
 * Maps the response of a FHIR search query to the actual FHIR resources.
 * @see {@link mapFhirData} for further information.
 *
 * @param {Object} res - the response of a FHIR search query.
 * @returns {Array} the resources in an array
 */
export function mapFhirResponse(res) {
  if (!res || !res.data || !res.data.entry || !Array.isArray(res.data.entry)) {
    return [];
  }
  return mapFhirData(res.data);
}

/**
 * Fetches the conformance statement.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} [params] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchConformanceStatement(fhirBaseUrl, params, token) {
  const resourceType = `metadata`;
  return fetchResources(fhirBaseUrl, resourceType, params, token);
}

/**
 * Fetches the Patient with the given &lt;code>id&lt;/code> from a FHIR server.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {String} id - id of the Patient to be fetched
 * @param {Object} [params] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchPatient(fhirBaseUrl, id, params, token) {
  const resourceType = `Patient`;
  return fetchResource(fhirBaseUrl, resourceType, id, params, token);
}

/**
 * Fetches Patients from a FHIR server.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} [params] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchPatients(fhirBaseUrl, params, token) {
  return fetchResources(fhirBaseUrl, "Patient", params, token);
}

/**
 * Fetches the Questionnaire with the given &lt;code>id&lt;/code> from a FHIR server.
 *
 * @param {String} fhirBaseUrl url of the FHIR-Server
 * @param {String} id - id of the Questionnaire to be fetched
 * @param {Object} [params] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchQuestionnaire(fhirBaseUrl, id, params, token) {
  const resourceType = `Questionnaire`;
  return fetchResource(fhirBaseUrl, resourceType, id, params, token);
}

/**
 * Fetches Questionnaires from a FHIR server.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} [params] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchQuestionnaires(fhirBaseUrl, params, token) {
  return fetchResources(fhirBaseUrl, "Questionnaire", params, token);
}

/**
 * Fetches ValueSet from a FHIR server.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {String} id - id of the ValueSet to be fetched
 * @param {Object} [params] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchValueSet(fhirBaseUrl, id, params, token) {
  const resourceType = `ValueSet`;
  return fetchResource(fhirBaseUrl, resourceType, id, params, token);
}

/**
 * Fetches ValueSets from a FHIR server.
 *
 * @param {String} fhirBaseUrl - the base URL of the FHIR server
 * @param {Object} [params] - the FHIR query params
 * @param {String} [token] - the authentication token
 * @returns {Promise} Promise object representing the response to the http call
 */
export function fetchValueSets(fhirBaseUrl, params, token) {
  return fetchResources(fhirBaseUrl, "ValueSet", params, token);
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#deleteResource">deleteResource</a></li><li><a href="global.html#deleteResourceById">deleteResourceById</a></li><li><a href="global.html#fetchByUrl">fetchByUrl</a></li><li><a href="global.html#fetchConformanceStatement">fetchConformanceStatement</a></li><li><a href="global.html#fetchPatient">fetchPatient</a></li><li><a href="global.html#fetchPatients">fetchPatients</a></li><li><a href="global.html#fetchQuestionnaire">fetchQuestionnaire</a></li><li><a href="global.html#fetchQuestionnaires">fetchQuestionnaires</a></li><li><a href="global.html#fetchResource">fetchResource</a></li><li><a href="global.html#fetchResources">fetchResources</a></li><li><a href="global.html#fetchResourcesPost">fetchResourcesPost</a></li><li><a href="global.html#fetchValueSet">fetchValueSet</a></li><li><a href="global.html#fetchValueSetConceptByUrl">fetchValueSetConceptByUrl</a></li><li><a href="global.html#fetchValueSets">fetchValueSets</a></li><li><a href="global.html#mapFhirData">mapFhirData</a></li><li><a href="global.html#mapFhirResponse">mapFhirResponse</a></li><li><a href="global.html#submitResource">submitResource</a></li><li><a href="global.html#submitResourceToUrl">submitResourceToUrl</a></li><li><a href="global.html#updateResource">updateResource</a></li><li><a href="global.html#updateResourceByUrl">updateResourceByUrl</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Tue Jan 19 2021 17:44:49 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
